#!/usr/bin/env bash
set -e

# Read pre-push hook arguments
remote="$1"
url="$2"

echo "Running pre-push checks..."

# Parse refs being pushed (format: local_ref local_sha remote_ref remote_sha)
while read -r local_ref local_sha remote_ref remote_sha; do
  # Check if pushing to main directly
  if [[ "$remote_ref" == "refs/heads/main" ]]; then
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    if [[ "$current_branch" != "main" ]]; then
      echo "ERROR: Direct push to main from '$current_branch' is not allowed"
      echo "Please create a pull request instead"
      exit 1
    fi
  fi
done

# Check 1: Run tests
echo "Running tests..."
if ! go test -timeout=2m ./...; then
  echo "ERROR: Tests failed"
  exit 1
fi

# Check 2: Run race detector with flaky test skipped
echo "Running race detector..."
export SKIP_RACE_FLAKY=1
if ! go test -race -timeout=3m ./...; then
  echo "ERROR: Race detector found issues"
  exit 1
fi

echo "âœ“ All pre-push checks passed"
